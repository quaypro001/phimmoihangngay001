<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Xem Phim Nhiều Tập</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #141414;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .header {
            width: 100%;
            background-color: #000;
            padding: 15px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2em;
        }
        .content {
            max-width: 1200px;
            width: 100%;
            margin: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .movie-list, .episode-list {
            flex: 1;
            min-width: 200px;
            background-color: #222;
            padding: 15px;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
        }
        .movie-list.hidden {
            display: none;
        }
        .movie-item, .episode-item, .server-item {
            padding: 8px;
            margin: 5px 0;
            background-color: #333;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .movie-item:hover, .episode-item:hover, .server-item:hover {
            background-color: #444;
        }
        .movie-item.active, .episode-item.active, .server-item.active {
            background-color: #e50914;
        }
        .video-container {
            flex: 2;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        iframe {
            width: 100%;
            max-width: 800px;
            height: 450px;
            border-radius: 8px;
            border: none;
        }
        .controls {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        button {
            padding: 8px 15px;
            font-size: 0.9em;
            cursor: pointer;
            background-color: #e50914;
            color: #fff;
            border: none;
            border-radius: 5px;
        }
        button:hover {
            background-color: #b2070f;
        }
        .description {
            margin-top: 15px;
            text-align: center;
            font-size: 0.9em;
        }
        .season-selector, .server-selector {
            margin-bottom: 10px;
            display: flex;
            overflow-x: auto;
            gap: 5px;
        }
        .season-button, .server-button {
            padding: 5px 10px;
            background-color: #333;
            color: #fff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 0.85em;
        }
        .season-button.active, .server-button.active {
            background-color: #e50914;
        }
        .season-button:hover, .server-button:hover {
            background-color: #444;
        }
        .toggle-movie-list {
            display: none;
            padding: 10px;
            background-color: #e50914;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }
        .toggle-movie-list:hover {
            background-color: #b2070f;
        }

        /* Responsive cho tablet và di động */
        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }
            .movie-list, .episode-list, .video-container {
                flex: none;
                width: 100%;
            }
            iframe {
                height: 200px;
            }
            .header h1 {
                font-size: 1.5em;
            }
            .toggle-movie-list {
                display: block;
            }
            .movie-list {
                display: none;
            }
            .movie-list.visible {
                display: block;
            }
        }
        @media (max-width: 480px) {
            .movie-list, .episode-list {
                padding: 10px;
                max-height: 300px;
            }
            .movie-item, .episode-item, .server-item {
                font-size: 0.8em;
            }
            button {
                padding: 6px 12px;
                font-size: 0.8em;
            }
            .description {
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Trang Xem Phim Nhiều Tập</h1>
        <button class="toggle-movie-list" onclick="toggleMovieList()">Danh sách phim</button>
    </div>
    <div class="content">
        <div class="movie-list" id="movieList"></div>
        <div class="episode-list" id="episodeList">
            <div class="season-selector" id="seasonSelector"></div>
            <div class="server-selector" id="serverSelector"></div>
        </div>
        <div class="video-container">
            <iframe id="videoPlayer" allow="autoplay; fullscreen" allowfullscreen></iframe>
            <div class="controls">
                <button onclick="reloadIframe()">Reload</button>
            </div>
            <div class="description" id="description"></div>
        </div>
    </div>

    <script>
        const videoPlayer = document.getElementById('videoPlayer');
        const movieList = document.getElementById('movieList');
        const episodeList = document.getElementById('episodeList');
        const seasonSelector = document.getElementById('seasonSelector');
        const serverSelector = document.getElementById('serverSelector');
        const description = document.getElementById('description');
        let movies = [];
        let selectedMovie = null;
        let selectedSeason = 0;
        let selectedServer = 0;
        let selectedMovieData = null;

        // Tải danh sách phim từ movies.json
        fetch('movies.json')
            .then(response => response.json())
            .then(data => {
                movies = data;
                renderMovieList();
            })
            .catch(error => console.error('Lỗi khi tải movies.json:', error));

        // Hiển thị danh sách phim
        function renderMovieList() {
            movieList.innerHTML = '';
            movies.forEach((movie, index) => {
                const movieItem = document.createElement('div');
                movieItem.className = 'movie-item';
                movieItem.textContent = movie.title;
                movieItem.onclick = () => {
                    selectMovie(index);
                    if (window.innerWidth <= 768) {
                        movieList.classList.remove('visible');
                        movieList.classList.add('hidden');
                    }
                };
                movieList.appendChild(movieItem);
            });
        }

        // Toggle danh sách phim trên di động
        function toggleMovieList() {
            if (movieList.classList.contains('visible')) {
                movieList.classList.remove('visible');
                movieList.classList.add('hidden');
            } else {
                movieList.classList.remove('hidden');
                movieList.classList.add('visible');
            }
        }

        // Chọn phim và tải dữ liệu chi tiết từ file JSON của phim
        function selectMovie(index) {
            selectedMovie = movies[index];
            document.querySelectorAll('.movie-item').forEach(item => item.classList.remove('active'));
            movieList.children[index].classList.add('active');
            selectedSeason = 0;
            selectedServer = 0;

            // Tải file JSON chi tiết của phim
            fetch(selectedMovie.dataFile)
                .then(response => response.json())
                .then(data => {
                    selectedMovieData = data;
                    renderSeasonSelector();
                    renderServerSelector();
                    renderEpisodeList();
                    description.innerHTML = `<strong>${selectedMovie.title}</strong><br>${selectedMovie.description || 'Không có mô tả.'}`;
                    if (selectedMovieData.seasons && selectedMovieData.seasons[0] && selectedMovieData.seasons[0].episodes.length > 0) {
                        selectEpisode(0); // Phát tập 1 của mùa 1, server đầu tiên
                    } else {
                        videoPlayer.src = '';
                    }
                })
                .catch(error => console.error(`Lỗi khi tải ${selectedMovie.dataFile}:`, error));
        }

        // Hiển thị selector mùa
        function renderSeasonSelector() {
            seasonSelector.innerHTML = '';
            if (selectedMovieData && selectedMovieData.seasons) {
                selectedMovieData.seasons.forEach((season, index) => {
                    const seasonButton = document.createElement('button');
                    seasonButton.className = 'season-button';
                    seasonButton.textContent = `Mùa ${index + 1} (${season.episodes.length} tập)`;
                    seasonButton.onclick = () => selectSeason(index);
                    if (index === selectedSeason) {
                        seasonButton.classList.add('active');
                    }
                    seasonSelector.appendChild(seasonButton);
                });
            } else {
                seasonSelector.innerHTML = '<p>Chọn một mùa để xem tập.</p>';
            }
        }

        // Chọn mùa và phát tập 1
        function selectSeason(index) {
            selectedSeason = index;
            document.querySelectorAll('.season-button').forEach(btn => btn.classList.remove('active'));
            seasonSelector.children[index].classList.add('active');
            selectedServer = 0; // Reset server khi chuyển mùa
            renderServerSelector();
            renderEpisodeList();
            if (selectedMovieData.seasons[selectedSeason].episodes.length > 0) {
                selectEpisode(0); // Phát tập 1 của mùa được chọn
            } else {
                videoPlayer.src = '';
            }
        }

        // Hiển thị selector server
        function renderServerSelector() {
            serverSelector.innerHTML = '';
            if (selectedMovieData && selectedMovieData.servers) {
                selectedMovieData.servers.forEach((server, index) => {
                    const serverButton = document.createElement('button');
                    serverButton.className = 'server-button';
                    serverButton.textContent = server.name;
                    serverButton.onclick = () => selectServer(index);
                    if (index === selectedServer) {
                        serverButton.classList.add('active');
                    }
                    serverSelector.appendChild(serverButton);
                });
            } else {
                serverSelector.innerHTML = '<p>Chọn server để xem.</p>';
            }
        }

        // Chọn server và cập nhật URL cho tập hiện tại
        function selectServer(index) {
            selectedServer = index;
            document.querySelectorAll('.server-button').forEach(btn => btn.classList.remove('active'));
            serverSelector.children[index].classList.add('active');
            // Cập nhật URL video cho tập hiện tại
            if (selectedMovieData.seasons[selectedSeason].episodes.length > 0 && episodeList.querySelector('.episode-item.active')) {
                const currentEpisodeIndex = Array.from(episodeList.querySelectorAll('.episode-item')).findIndex(item => item.classList.contains('active'));
                if (currentEpisodeIndex !== -1) {
                    selectEpisode(currentEpisodeIndex);
                }
            }
        }

        // Hiển thị danh sách tập
        function renderEpisodeList() {
            const episodeContainer = episodeList.querySelector('.episode-container') || document.createElement('div');
            episodeContainer.className = 'episode-container';
            episodeContainer.innerHTML = '';
            if (selectedMovieData && selectedMovieData.seasons && selectedMovieData.seasons[selectedSeason]) {
                selectedMovieData.seasons[selectedSeason].episodes.forEach((episode, index) => {
                    const episodeItem = document.createElement('div');
                    episodeItem.className = 'episode-item';
                    episodeItem.textContent = episode.title;
                    episodeItem.onclick = () => selectEpisode(index);
                    if (index === 0) {
                        episodeItem.classList.add('active'); // Đánh dấu tập 1
                    }
                    episodeContainer.appendChild(episodeItem);
                });
                episodeList.innerHTML = '';
                episodeList.appendChild(seasonSelector);
                episodeList.appendChild(serverSelector);
                episodeList.appendChild(episodeContainer);
            } else {
                episodeList.innerHTML = '<p>Chọn một mùa để xem tập.</p>';
            }
        }

        // Chọn tập và tải video từ server được chọn
        function selectEpisode(index) {
            const episode = selectedMovieData.seasons[selectedSeason].episodes[index];
            const server = selectedMovieData.servers[selectedServer];
            const serverUrl = episode.urls[server.name] || '';
            videoPlayer.src = serverUrl;
            document.querySelectorAll('.episode-item').forEach(item => item.classList.remove('active'));
            episodeList.querySelectorAll('.episode-item')[index].classList.add('active');
        }

        // Reload iframe để phát lại video
        function reloadIframe() {
            const currentSrc = videoPlayer.src;
            videoPlayer.src = '';
            setTimeout(() => {
                videoPlayer.src = currentSrc;
            }, 100);
        }
    </script>
</body>
</html>
